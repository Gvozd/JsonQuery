/*! JsonQuery - v0.2.0 - 2014-11-05
* https://github.com/Gvozd/JsonQuery/
* Copyright (c) 2014 Gvozdev Viktor; Licensed MIT */
var JsonQuery=function(){"use strict";function a(a,b){var c=e(b);if(Z.currentRootStack=c[0][0].stack,!a)throw new Error("empty filter function");return c.filter(a)}function b(a){this.push.apply(this,a),a[a.length-1].stack=this}function c(a,b){this.property=a,this.value=b}function d(a){var e,f,g,h,i,j=a[a.length-1].value;if(null!==j&&"object"==typeof j)for(a.children=[],a.descendants=[],e=Object.keys(j),g=0;g<e.length;g++)f=e[g],h=new c(f,j[f]),i=new b(a.slice().concat([h])),d(i),a.children.push(i),a.descendants.push.apply(a.descendants,i.descendants),a.descendants.push(i)}function e(a){var e=new c("",a),f=new b([e]);return d(f),f.descendants.concat([f])}function f(a,b,c){return b.substr(c,a.length)===a?{res:a,end:c+a.length}:void 0}function g(a,b,c){var d;return a.global&&(a.lastIndex=0),d=a.exec(b.slice(c)),d&&0===d.index?{res:d[0],end:c+d[0].length}:void 0}function h(a,b){return a.length===b?{res:"",end:b}:void 0}function i(a,b,c){return a(b,c)||{res:void 0,end:c}}function j(a,b,c,d){return!b(c,d)&&a(c,d)}function k(a,b,c){var d,e;for(e=0;e<a.length;e+=1)if(d=a[e](b,c))return d}function l(a,b,c){var d,e,f=[],g=c;for(e=0;e<a.length;e+=1){if(d=a[e](b,g),!d)return;f.push(d.res),g=d.end}return{res:f,end:g}}function m(a,b,c,d,e){var f,g=[],h=a(d,e),i=e;if(h){for(;h&&h.end>i&&(i=h.end,c&&f&&g.push(f.res),g.push(h.res),!b||(f=b(d,i)));)h=a(d,i);return{res:g,end:i}}}function n(a,b,c,d){if("function"!=typeof b)throw new Error("need transform function");var e=a(c,d);return e&&{res:b(e.res),end:e.end}}function o(a,b){function c(c){return c.length<2?!1:b(c)&&a(c[c.length-2].stack)}return c.toString=function(){return"greaterCombinator("+a+", "+b+")"},c}function p(a,b){function c(c){var d;if(c.length<2)return!1;if(!b(c))return!1;for(d=c.length-2;d>=0;d--)if(a(c[d].stack))return!0;return!1}return c.toString=function(){return"spaceCombinator("+a+", "+b+")"},c}function q(){function a(){return!0}return a.toString=function(){return"any()"},a}function r(a){function b(b){return a===b[b.length-1].property}return b.toString=function(){return"name("+JSON.stringify(a)+")"},b}function s(a){return function(){throw new Error("Not implemented: "+JSON.stringify(a))}}function t(a){function b(b){return a===u(b[b.length-1].value)}return b.toString=function(){return"type("+JSON.stringify(a)+")"},b}function u(a){return Array.isArray(a)?"array":null===a?"null":typeof a}function v(a){function b(b){var c,d=Z.currentRootStack;return Z.currentRootStack=b,c=b.descendants.some(a),Z.currentRootStack=d,c}return b.toString=function(){return"has("+a+")"},b}function w(){function a(a){return a.length<2?!1:Array.isArray(a[a.length-2].value)&&0===parseInt(a[a.length-1].property,10)}return a.toString=function(){return"firstChild()"},a}function x(){function a(a){return a.length<2?!1:Array.isArray(a[a.length-2].value)&&parseInt(a[a.length-1].property,10)===a[a.length-2].value.length-1}return a.toString=function(){return"lastChild()"},a}function y(a){var b,c,d,e=/^(-?\d*)n(?=[+\-]|\))\+?(-?\d+)?$/;if("even"===a)b=2,c=1;else if("odd"===a)b=2,c=0;else if(null!==a.match(/^-?\d+$/))b=0,c=parseInt(a||0,10)-1;else{if(null===a.match(e))throw new Error("Lexical error on line 1. Unrecognized expression.\n:nth-child("+a+")");d=a.match(e),b=parseInt(d[1],10),b=isNaN(b)?parseInt(d[1]+"1",10):b,c=parseInt(d[2]||0,10)-1}return{a:b,b:c}}function z(a){var b=y(a),c=b.a,d=b.b,e=function(a){var b,e;if(a.length<2)return!1;if(b=a[a.length-2].value,Array.isArray(b))for(e=d;e<b.length&&e>=0;e+=c){if(parseInt(a[a.length-1].property,10)===e)return!0;if(0===c)return!1}return!1};return e.toString=function(){return"nthChild("+a+")"},e}function A(a){var b=y(a),c=b.a,d=b.b,e=function(a){var b,e;if(a.length<2)return!1;if(b=a[a.length-2].value,Array.isArray(b))for(e=b.length-1-d;e<b.length&&e>=0;e-=c){if(parseInt(a[a.length-1].property,10)===e)return!0;if(0===c)return!1}return!1};return e.toString=function(){return"nthLastChild("+a+")"},e}function B(){function a(a){return a===Z.currentRootStack}return a.toString=function(){return"root(???)"},a}function C(a){function b(b){return b[b.length-1].value===a}return a=JSON.parse(a),b.toString=function(){return"val("+JSON.stringify(a)+")"},b}function D(a,b){switch(a){case"nth-child":return z(b);case"nth-last-child":return A(b);case"val":return C(b);default:return s(["Functional pseudo: "+a])}}function E(a){switch(a){case"root":return B();case"first-child":return w();case"last-child":return x();default:return s(["pseudo "+a])}}function F(){function a(a){for(var c=0;c<b.length;c++)if(!b[c](a))return!1;return!0}var b,c;return b=Array.prototype.filter.call(arguments,function(a){return"function"==typeof a}),c=b.join(", "),0===b.length?null:1===b.length?b[0]:(a.toString=function(){return"unionAnd("+c+")"},a)}function G(){function a(a){for(var c=0;c<b.length;c++)if(b[c](a))return!0;return!1}var b,c;return b=Array.prototype.filter.call(arguments,function(a){return"function"==typeof a}),c=b.join(", "),0===b.length?null:1===b.length?b[0]:(a.toString=function(){return"unionOr("+c+")"},a)}function H(a,b){return $.sequence(I,$.optionalRepeat($.sequence($.regexp(Fb,"i"),$.optionalRepeat($.regexp(sb,"i")),I).then(function(a){return a[2]}))).then(function(a){var b,c;if(b=a[0],a[1])for(c=0;c<a[1].length;c++)b=G(b,a[1][c]);return b})(a,b)}function I(a,b){return $.sequence(K,$.optionalRepeat($.sequence(J,K))).then(function(a){var b,c=a[0];if(a[1])for(b=0;b<a[1].length;b++)c=a[1][b][0](c,a[1][b][1]);return c})(a,b)}function J(a,b){return $.any($.sequence($.regexp(Db,"i"),$.optionalRepeat($.regexp(sb,"i"))).then(function(a){return s("PLUS combinator",a)}),$.sequence($.regexp(Eb,"i"),$.optionalRepeat($.regexp(sb,"i"))).then(function(){return o}),$.sequence($.regexp(Gb,"i"),$.optionalRepeat($.regexp(sb,"i"))).then(function(a){return s("TILDE combinator",a)}),$.repeat($.regexp(sb,"i")).then(function(){return p}))(a,b)}function K(a,b){return $.any($.sequence($.any(L,O),$.optionalRepeat($.any($.regexp(Cb,"i"),P,Q,U,W,R))),$.repeat($.any($.regexp(Cb,"i"),P,Q,U,W,R)).then(function(a){return[null,a]})).then(function(a){var b,c;if(b=a[0],a[1])for(c=0;c<a[1].length;c++)b=F(b,a[1][c]);return b})(a,b)}function L(a,b){return $.sequence($.optional(M),N).then(function(a){return t(a[1]||a[0])})(a,b)}function M(a,b){return $.sequence($.optional($.any($.regexp(yb,"i"),$.text("*"))),$.text("|")).then(function(a){return s("namespace_prefix",a)})(a,b)}function N(a,b){return $.regexp(yb,"i")(a,b)}function O(a,b){return $.sequence($.optional(M),$.text("*")).then(function(){return q()})(a,b)}function P(a,b){return $.sequence($.text("."),$.any($.regexp(zb,"i").then(function(a){return'"'===a[0]&&'"'===a[a.length-1]?a.slice(1,-1).replace(/\\"/,'"'):"'"===a[0]&&"'"===a[a.length-1]?a.slice(1,-1).replace(/\\'/,"'"):void 0}),$.regexp(yb,"i"))).then(function(a){return r(a[1])})(a,b)}function Q(a,b){return $.sequence($.text("["),$.optionalRepeat($.regexp(sb,"i")),$.optional(M),$.regexp(yb,"i"),$.optionalRepeat($.regexp(sb,"i")),$.optional($.sequence($.any($.regexp(vb,"i"),$.regexp(wb,"i"),$.regexp(xb,"i"),$.text("="),$.regexp(tb,"i"),$.regexp(ub,"i")),$.optionalRepeat($.regexp(sb,"i")),$.any($.regexp(yb,"i"),$.regexp(zb,"i")),$.optionalRepeat($.regexp(sb,"i")))),$.text("]")).then(function(a){return s("attrib",a)})(a,b)}function R(a,b){return $.sequence($.text(":"),$.optional($.text(":")),$.any(S,$.regexp(yb,"i").then(function(a){return E(a)}))).then(function(a){return a[2]})(a,b)}function S(a,b){return $.sequence($.regexp(Ab,"i"),$.optionalRepeat($.regexp(sb,"i")),T,$.text(")")).then(function(a){return D(a[0].slice(0,-1),a[2])})(a,b)}function T(a,b){return $.repeat($.sequence($.any($.regexp(Db,"i"),$.text("-"),$.regexp(Jb,"i"),$.regexp(Bb,"i"),$.regexp(zb,"i"),$.regexp(yb,"i")),$.optionalRepeat($.regexp(sb,"i"))).then(function(a){return a[0]})).then(function(a){return a.join("")})(a,b)}function U(a,b){return $.sequence($.regexp(Hb,"i"),$.optionalRepeat($.regexp(sb,"i")),V,$.optionalRepeat($.regexp(sb,"i")),$.text(")"))(a,b)}function V(a,b){return $.any(L,O,$.regexp(Cb,"i"),P,Q,R)(a,b)}function W(a,b){return $.sequence($.regexp(Ib,"i"),$.optionalRepeat($.regexp(sb,"i")),H,$.optionalRepeat($.regexp(sb,"i")),$.text(")")).then(function(a){return v(a[2])})(a,b)}function X(a){var b,c,d;for(a=a||{},b=1;b<arguments.length;b++){c=arguments[b];for(d in c)c.hasOwnProperty(d)&&(a[d]=c[d])}return a}function Y(b,c,d){var e,f;if(!(this instanceof Y))return new Y(b,c,d);if(e=H(b,0),!e)throw new Error("Wrong selector: "+b);return e=e.res,d=X({},Y.defaultOptions,d),f=a(e,c,d),Object.defineProperty(this,"length",{enumerable:!1,value:f.length}),f.forEach(function(a,b){this[b]=a[a.length-1].value},this),Object.defineProperty(this,"filter",{enumerable:!1,value:e}),Object.defineProperty(this,"splice",{enumerable:!1,value:function(){throw new Error("dummy method")}}),this}var Z={currentRootStack:null};b.prototype=Object.create(Array.prototype),b.prototype.constructor=b,b.prototype.children=[],b.prototype.descendants=[],c.prototype.property="",c.prototype.value=void 0,c.prototype.stack=null;var $={};$.text=function(a){var b=f.bind($,a);return b.then=$.then.bind($,b),b},$.regexp=function(a,b){var c;return"string"==typeof a&&(a=new RegExp("^(?:"+a+")",b||"")),c=g.bind($,a),c.then=$.then.bind($,c),c},$.end=function(){var a=h.bind($);return a.then=$.then.bind($,a),a},$.optional=function(a){var b=i.bind($,a);return b.then=$.then.bind($,b),b},$.exclude=function(a,b){var c=j.bind($,a,b);return c.then=$.then.bind($,c),c},$.any=function(a){var b="function"==typeof a?arguments:a,c=k.bind($,b);return c.then=$.then.bind($,c),c},$.sequence=function(a){var b="function"==typeof a?arguments:a,c=l.bind($,b);return c.then=$.then.bind($,c),c},$.repeat=function(a,b,c){var d=m.bind($,a,b,c);return d.then=$.then.bind($,d),d},$.optionalRepeat=function(a,b,c){var d=i.bind($,m.bind($,a,b,c));return d.then=$.then.bind($,d),d},$.then=function(a,b){var c=n.bind($,a,b);return c.then=$.then.bind($,c),c};var _="\\n|\\r\\n|\\r|\\f",ab="[^\\0-\\177]",bb="[0-9]+|[0-9]*\\.[0-9]+",cb="\\\\[0-9a-f]{1,6}(?:\\r\\n|[ \\n\\r\\t\\f])?",db="(?:"+cb+")|\\\\[^\\n\\r\\f0-9a-f]",eb="[_a-z]|(?:"+ab+")|(?:"+db+")",fb="[_a-z0-9-]|(?:"+ab+")|(?:"+db+")",gb="(?:"+fb+")+",hb="[-]?(?:"+eb+")(?:"+fb+")*",ib='\\"(?:[^\\n\\r\\f\\\\"]|\\\\(?:'+_+")|(?:"+ab+")|(?:"+db+'))*\\"',jb="\\'(?:[^\\n\\r\\f\\\\']|\\\\(?:"+_+")|(?:"+ab+")|(?:"+db+"))*\\'",kb="(?:"+ib+")|(?:"+jb+")",lb="[ \\t\\r\\n\\f]*",mb="n|\\\\0{0,4}(4e|6e)(\\r\\n|[ \\t\\r\\n\\f])?|\\\\n",nb="o|\\\\0{0,4}(4f|6f)(\\r\\n|[ \\t\\r\\n\\f])?|\\\\o",ob="t|\\\\0{0,4}(54|74)(\\r\\n|[ \\t\\r\\n\\f])?|\\\\t",pb="h|\\\\0{0,4}(48|68)(\\r\\n|[ \\t\\r\\n\\f])?|\\\\h",qb="a|\\\\0{0,4}(41|61)(\\r\\n|[ \\t\\r\\n\\f])?|\\\\a",rb="s|\\\\0{0,4}(53|73)(\\r\\n|[ \\t\\r\\n\\f])?|\\\\s",sb="[ \\t\\r\\n\\f]+",tb="~=",ub="|=",vb="\\^=",wb="\\$=",xb="\\*=",yb="(?:"+hb+")",zb="(?:"+kb+")",Ab="(?:"+hb+")\\(",Bb="(?:"+bb+")",Cb="#(?:"+gb+")",Db="(?:"+lb+")\\+",Eb="(?:"+lb+")>",Fb="(?:"+lb+"),",Gb="(?:"+lb+")~",Hb=":(?:"+mb+")(?:"+nb+")(?:"+ob+")[ \\t\\r\\n\\f]*\\(",Ib=":(?:"+pb+")(?:"+qb+")(?:"+rb+")[ \\t\\r\\n\\f]*\\(",Jb="(?:"+bb+")(?:"+hb+")";return Y.prototype=Array.prototype,Y.defaultOptions={excludeFilters:[]},"function"==typeof define&&define.amd&&define("JsonQuery",[],function(){return Y}),Y}();